var bind=function(t,n){return function(){return t.apply(n,arguments)}};define(["external/underscore","modules/constants/comments_panel","modules/constants/legacy","modules/core/exception","modules/clean/annotations/annotation","modules/clean/comments/store","modules/clean/comments/revisions","modules/clean/comments/utils","modules/clean/keycode","modules/clean/react/file_comments/logger","modules/clean/react/file_viewer/store","modules/clean/string"],function(t,n,o,e,i,a,r,s,c,l,h,u){var v,d,A,assert,p,C;return assert=e.assert,d=i.Annotation,C=u.lispToPascalCase,v=["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","page-rendered","annotation-ui-click","annotation-ui-enter","annotation-ui-leave","annotation-enter","annotation-leave","scale-change","scroll","on-keydown","reset-file-feedback-ui","mouse-up"],p=n.ALLOW_ANNOTATION_GHOST,A=function(){function n(t){this.prevState=t.prevState,this.state=t.state,this.interfaceController=t.interfaceController,this.actionCreators=t.actionCreators,this.onResetFileFeedbackUi=bind(this.onResetFileFeedbackUi,this),this.onMouseUp=bind(this.onMouseUp,this),this.onOnKeydown=bind(this.onOnKeydown,this),this.onScroll=bind(this.onScroll,this),this.onScaleChange=bind(this.onScaleChange,this),this.onAnnotationUiLeave=bind(this.onAnnotationUiLeave,this),this.onAnnotationUiEnter=bind(this.onAnnotationUiEnter,this),this.onAnnotationUiClick=bind(this.onAnnotationUiClick,this),this.onAnnotationEndDrag=bind(this.onAnnotationEndDrag,this),this.onAnnotationStartDrag=bind(this.onAnnotationStartDrag,this),this.onAnnotationPlaced=bind(this.onAnnotationPlaced,this),this.onAnnotationHidden=bind(this.onAnnotationHidden,this),this.onStateChange=bind(this.onStateChange,this)}return n.create=function(t){return new n({prevState:{activityKeys:[],hasEphemeral:!1},state:{ephemeralAnnotation:null,commentActivityByKey:{},canAnnotate:!1,regionCreationEnabled:!1,viewingAnnotationConversation:!1},interfaceController:null,actionCreators:t})},n.prototype.setState=function(n){return t.extend(this.state,n),this.performUpdateIfNecessary()},n.prototype.getStateFromStores=function(){var n,o,e,i,r;return r=a.state.showResolvedComments,o=!1,n=s.shouldShowExistingAnnotations()?a.state.activity.comment_activities.filter(function(t){var n;return t.comment.resolved&&o?!1:null!=(null!=(n=t.comment.comment_metadata)?n.annotation:void 0)}):{},{activityKey:null!=(e=a.state.activity)?e.activity_key:void 0,actorId:a.state.actorId,activityContext:a.state.viewing.context,revision:a.state.viewing.revision,commentActivityByKey:t.indexBy(n,"activity_key"),ephemeralAnnotation:null!=(i=a.state.createAnnotation)?i.annotation:void 0,canAnnotate:s.canAnnotate(),regionCreationEnabled:s.isRegionCreationEnabled(),showResolved:r,viewingAnnotationConversation:null!=a.state.viewAnnotation}},n.prototype.onStateChange=function(){return null!=a.state.activity?this.setState(this.getStateFromStores()):void 0},n.prototype.mount=function(t){return assert(null!=t,"Interface controller must not be null"),assert(!this.isMounted(),"FilePreviewAnnotations instance is already mounted"),this.prevState={},this.interfaceController=t,this.onStateChange(a.state),this.unsubscribeStore=a.listen(this.onStateChange),this.unsubscribeFileViewerStore=h.addListener(this.onStateChange),this.addAnnotationEventListeners(),this.performUpdateIfNecessary()},n.prototype.unmount=function(){return assert(this.isMounted(),"FilePreviewAnnotations instance is not mounted"),this.unsubscribeStore(),"function"==typeof this.unsubscribeFileViewerStore&&this.unsubscribeFileViewerStore(),this.disableAnnotationCreation(),this.removeAnnotationEventListeners(),this.interfaceController=null,window.clearTimeout(this.annotationBubbleTimer)},n.prototype.isMounted=function(){return null!=this.interfaceController},n.prototype.enableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("enable-annotation-creation")},n.prototype.disableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("disable-annotation-creation")},n.prototype.enableRegionCreation=function(){return this.interfaceController.dispatchEvent("enable-region-creation")},n.prototype.disableRegionCreation=function(){return this.interfaceController.dispatchEvent("disable-region-creation")},n.prototype.addAnnotationEventListeners=function(){return v.forEach(function(t){return function(n){var o,e;return e="on"+C(n),o=t[e],null!=o?t.interfaceController.on(n,o):void 0}}(this))},n.prototype.removeAnnotationEventListeners=function(){return v.forEach(function(t){return function(n){var o,e;return e="on"+C(n),o=t[e],null!=o?t.interfaceController.off(n,o):void 0}}(this))},n.prototype.onAnnotationHidden=function(t){return this.actionCreators.stopAnnotationCreation()},n.prototype.onAnnotationPlaced=function(t){var n;return n=d.createAnnotationFromDict(t.annotation),this.actionCreators.startAnnotationCreation({annotation:n}),l.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},n.prototype.onAnnotationStartDrag=function(t){return this.actionCreators.hideAnnotationConversation(),this.actionCreators.hideAnnotationInput()},n.prototype.onAnnotationEndDrag=function(t){var n;return this.actionCreators.hideAnnotationConversation(),n=d.createAnnotationFromDict(t.annotation),this.actionCreators.startAnnotationCreation({annotation:n}),l.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},n.prototype.onAnnotationUiClick=function(t){var n,e;return n=t.commentActivity.activity_key,this.actionCreators.revealAnnotationInPreview(n),this.actionCreators.revealCommentInPane({activityKey:n,expandConversation:!1}),l.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this.state.activityKey,null!=(e=t.commentActivity)?e.activity_key:void 0,this.state.actorId,this.state.activityContext)},n.prototype.onAnnotationUiEnter=function(t){var n,e;if(null==this.state.ephemeralAnnotation&&(null!=(n=a.state.viewAnnotation)?!n.replyFocused:!0))return this.actionCreators.showAnnotationConversation({activityKey:t.commentActivity.activity_key,annotation:d.createAnnotationFromDict(t.annotation)}),l.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this.state.activityKey,null!=(e=t.commentActivity)?e.activity_key:void 0,this.state.actorId,this.state.activityContext)},n.prototype.onAnnotationUiLeave=function(t){var n,o;return this.actionCreators.updateAnnotationUiHover(!1),null!=this.state.ephemeralAnnotation||(null!=(o=a.state.viewAnnotation)?o.replyFocused:0)?void 0:(n=function(t){return function(){var n,o;return!t.isMounted()||(null!=(n=a.state.viewAnnotation)?n.conversationHover:void 0)||(null!=(o=a.state.viewAnnotation)?o.annotationHover:void 0)?void 0:t.actionCreators.hideAnnotationConversation()}}(this),window.setTimeout(n,50))},n.prototype.onScaleChange=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},n.prototype.onScroll=function(n){var o;return this.actionCreators.hideAnnotationInput(),this.actionCreators.hideAnnotationConversation(),window.clearTimeout(this.annotationBubbleTimer),o=t.partial(function(t){return function(n){var o;return null!=(null!=n?n.annotation:void 0)?(o=d.createAnnotationFromDict(n.annotation),t.actionCreators.startAnnotationCreation({annotation:o})):t.actionCreators.showAnnotationInput()}}(this),n),this.annotationBubbleTimer=window.setTimeout(o,150)},n.prototype.onOnKeydown=function(t){return s.normalizedKeyCode.apply(t)===c.ESC?this.actionCreators.stopAnnotationCreation():void 0},n.prototype.onMouseUp=function(t){return null!=this.state.viewingAnnotationConversation?this.actionCreators.hideAnnotationConversation():void 0},n.prototype.onResetFileFeedbackUi=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},n.prototype._savePrevState=function(){var t;return this.prevState={activityKeys:Object.keys(null!=(t=this.state.commentActivityByKey)?t:{}),hasEphemeral:null!=this.state.ephemeralAnnotation,canAnnotate:this.state.canAnnotate,regionCreationEnabled:this.state.regionCreationEnabled,viewingAnnotationConversation:this.state.viewingAnnotationConversation}},n.prototype._removeAnnotation=function(t){return this.interfaceController.dispatchEvent("remove-annotation",{commentActivity:{activity_key:t}})},n.prototype._updateAnnotations=function(t){var n,o,e,i,a,s,c,l,h,u;for(e=[],o=0,a=0,l=t.length;l>a;a++)i=t[a],i.comment.hasMetadata()&&i.comment.comment_metadata.hasAnnotationData()&&(o+=1,!this.state.showResolved&&i.comment.resolved||(h=i.comment.comment_metadata,n=h.annotation,u=h.revision,s=r.isRevisionEqual(this.state.revision,u),(p||null!=u&&s)&&(c=p&&null!=u&&!s,e.push({annotation:n,commentActivity:i,options:{isGhostAnnotation:c,isAnnotationNumberingEnabled:!0,annotationNumber:o}}))));return this.interfaceController.dispatchEvent("update-annotations",{annotations:e})},n.prototype.performUpdateIfNecessary=function(){var n,o;if(this.isMounted())return t.isEmpty(this.state.commentActivityByKey)?this.interfaceController.dispatchEvent("remove-all-annotations"):(n=t.difference(null!=(o=this.prevState.activityKeys)?o:[],Object.keys(this.state.commentActivityByKey)),n.forEach(this._removeAnnotation,this),this._updateAnnotations(t.values(this.state.commentActivityByKey))),this.prevState.hasEphemeral&&null==this.state.ephemeralAnnotation&&this.interfaceController.dispatchEvent("hide-annotation"),this.prevState.canAnnotate!==this.state.canAnnotate&&(this.state.canAnnotate?this.enableAnnotationCreation():this.disableAnnotationCreation()),this.prevState.regionCreationEnabled!==this.state.regionCreationEnabled&&(this.state.regionCreationEnabled?this.enableRegionCreation():this.disableRegionCreation()),this.prevState.viewingAnnotationConversation!==this.state.viewingAnnotationConversation&&(this.state.viewingAnnotationConversation?this.disableRegionCreation():this.state.regionCreationEnabled&&this.enableRegionCreation()),this._savePrevState()},n}()});
//# sourceMappingURL=file_preview_annotations.min.js-vflNnj-YB.map