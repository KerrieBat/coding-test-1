var bind=function(e,t){return function(){return e.apply(t,arguments)}};define(["external/modernizr","jquery","modules/clean/ajax","modules/clean/unity/features","modules/core/browser","modules/core/exception","modules/core/uri"],function(e,t,i,n,r,_,o){var s;if(null!=n)return s=function(){function t(){this._assert_is_initialized=bind(this._assert_is_initialized,this),this._direct_web_destiny=bind(this._direct_web_destiny,this),this.is_direct_allowed=bind(this.is_direct_allowed,this),this.user_display_name=bind(this.user_display_name,this),this.continue_as_user=bind(this.continue_as_user,this),this._cached_web_destiny_info=null}return t.Error={UNITY_CONNECTION_ERROR:"unity_connection_error",REFRESH_TIMEOUT:"refresh_timeout",LOGIN_REQUEST_ERROR:"login_request_error"},t._DESTINY_REFRESH_TOKEN_KEY="web-destiny-refresh-token",t._DESTINY_MANUAL_REFRESH_TIMEOUT=5e3,t._DESTINY_REFRESH_TIMEOUT=1e4,t.finish_indirect_web_destiny=function(t){var i;return e.localstorage?(localStorage.setItem(this._DESTINY_REFRESH_TOKEN_KEY,t),i=localStorage.getItem("web-destiny-redirect-uri"),localStorage.removeItem("web-destiny-redirect-uri"),i?r.redirect(i):r.redirect("/")):r.redirect("/")},t.prototype.start_connection=function(e,t){return null==t&&(t=null),null==this._cached_web_destiny_info?n.web_destiny_info(function(t){return function(i){return null!=i?(t._cached_web_destiny_info=i,e(i.user_display_name)):void 0}}(this),t):void 0},t.prototype.continue_as_user=function(e,t){var i,n;return null==e&&(e=null),null==t&&(t=null),this._assert_is_initialized(),i=function(){return null!=e?r.redirect(e):window.location.reload()},n=function(e){return null!=t?t(e):void 0},this._cached_web_destiny_info.is_direct_allowed?this._direct_web_destiny(i,n):this._indirect_web_destiny(i,n)},t.prototype.user_display_name=function(){return this._assert_is_initialized(),this._cached_web_destiny_info.user_display_name},t.prototype.is_direct_allowed=function(){return this._assert_is_initialized(),this._cached_web_destiny_info.is_direct_allowed},t.prototype._indirect_web_destiny=function(i,_){var o,s,u,d;return d=null,u=null,e.localstorage&&(d=(new Date).getTime().toString(),s=function(e){return e.key===t._DESTINY_REFRESH_TOKEN_KEY&&e.newValue===d?(window.clearTimeout(u),i()):void 0},null!=window.addEventListener?window.addEventListener("storage",s,!1):window.attachEvent("onstorage",s)),o=function(){return u=e.localstorage?window.setTimeout(function(){return _(t.Error.REFRESH_TIMEOUT)},t._DESTINY_REFRESH_TIMEOUT):window.setTimeout(i,t._DESTINY_MANUAL_REFRESH_TIMEOUT)},n.continue_as_user(r.browser_name,d,o,function(){return _(t.Error.UNITY_CONNECTION_ERROR)})},t.prototype._direct_web_destiny=function(e,r){var s;return _.assert(this._cached_web_destiny_info.is_direct_allowed,"Direct Web Destiny is not allowed."),s=function(n){var _,s,u;return _={i:function(){var e;e=[];for(s in n)u=n[s],e.push(s);return e}(),n:function(){var e;e=[];for(s in n)u=n[s],e.push(u);return e}(),return_json:!0},i.WebRequest({url:o({path:"/desktop_login"}),data:_,success:e,error:function(){return r(t.Error.LOGIN_REQUEST_ERROR)}})},n.continue_as_user_direct(s,function(){return r(t.Error.UNITY_CONNECTION_ERROR)})},t.prototype._assert_is_initialized=function(){return _.assert(null!=this._cached_web_destiny_info,"Method not allowed. WebDestiny was not initialized.")},t}()});
//# sourceMappingURL=web_destiny.min.js-vflb0KNAC.map